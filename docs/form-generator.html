<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZZZ Guide YAML Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #4f46e5;
            --primary-hover: #4338ca;
            --success-color: #10b981;
            --error-color: #ef4444;
            --border-color: #e5e7eb;
            --bg-color: #f9fafb;
            --section-bg: #ffffff;
            --text-color: #111827;
            --text-muted: #6b7280;
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: var(--section-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .subtitle {
            color: var(--text-muted);
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .form-container,
        .preview-container {
            background: var(--section-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: var(--shadow);
        }

        .section {
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
        }

        .section-header {
            background: var(--bg-color);
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            transition: background 0.2s;
        }

        .section-header:hover {
            background: #f3f4f6;
        }

        .section-header h2 {
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .required-badge {
            background: var(--error-color);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: normal;
        }

        .optional-badge {
            background: var(--text-muted);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: normal;
        }

        .section-toggle {
            font-size: 1.5em;
            transition: transform 0.3s;
        }

        .section-toggle.collapsed {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 20px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s;
        }

        .section-content.collapsed {
            max-height: 0;
            padding: 0 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color);
        }

        .label-with-help {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--text-muted);
            color: white;
            font-size: 12px;
            cursor: help;
            position: relative;
        }

        .help-icon:hover::after {
            content: attr(data-help);
            position: absolute;
            left: 30px;
            top: -10px;
            background: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            width: 250px;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            font-weight: normal;
        }

        input[type="text"],
        input[type="date"],
        input[type="url"],
        select,
        textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            font-size: 15px;
            font-family: inherit;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        input.valid,
        textarea.valid {
            border-color: var(--success-color);
        }

        input.invalid,
        textarea.invalid {
            border-color: var(--error-color);
        }

        textarea {
            min-height: 100px;
            resize: vertical;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
        }

        button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            transition: background 0.2s, transform 0.1s;
        }

        button:hover {
            background: var(--primary-hover);
        }

        button:active {
            transform: scale(0.98);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #9ca3af;
        }

        button:disabled:hover {
            background: #9ca3af;
            transform: none;
        }

        .button-secondary {
            background: #6b7280;
        }

        .button-secondary:hover {
            background: #4b5563;
        }

        .button-success {
            background: var(--success-color);
        }

        .button-success:hover {
            background: #059669;
        }

        .button-danger {
            background: var(--error-color);
        }

        .button-danger:hover {
            background: #dc2626;
        }

        .button-small {
            padding: 6px 12px;
            font-size: 13px;
        }

        .repeatable-item {
            position: relative;
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 15px;
            background: var(--bg-color);
        }

        .remove-button {
            position: absolute;
            top: 10px;
            right: 10px;
        }

        .add-button {
            width: 100%;
            background: var(--success-color);
            margin-top: 10px;
        }

        .add-button:hover {
            background: #059669;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .action-buttons button {
            flex: 1;
            min-width: 150px;
        }

        #yamlPreview {
            background: #1f2937;
            color: #f9fafb;
            padding: 20px;
            border-radius: 6px;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            overflow-x: auto;
            white-space: pre-wrap;
            word-wrap: break-word;
            min-height: 400px;
            max-height: 800px;
            overflow-y: auto;
        }

        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .validation-message {
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .validation-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid var(--success-color);
        }

        .validation-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid var(--error-color);
        }

        .validation-warning {
            background: #fef3c7;
            color: #92400e;
            border: 1px solid #f59e0b;
        }

        .validation-errors {
            margin-top: 10px;
            font-size: 13px;
        }

        .validation-errors ul {
            margin-left: 20px;
            margin-top: 5px;
        }

        .skill-priority-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
        }


        .top-actions {
            background: var(--section-bg);
            padding: 20px;
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .team-member-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 10px;
        }

        .team-member-item {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .team-member-item input {
            flex: 1;
        }

        .priority-tier {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 15px;
        }

        .priority-tier h4 {
            margin-bottom: 10px;
            color: var(--text-color);
        }

        .floating-toolbox {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--section-bg);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            max-width: 250px;
            display: none;
        }

        .floating-toolbox.visible {
            display: block;
        }

        .floating-toolbox-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }

        .floating-toolbox-header h3 {
            font-size: 14px;
            margin: 0;
            color: var(--text-color);
        }

        .floating-toolbox-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            border-radius: 4px;
        }

        .floating-toolbox-close:hover {
            background: var(--bg-color);
            color: var(--text-color);
        }

        .floating-toolbox-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toolbox-category {
            margin-bottom: 8px;
        }

        .toolbox-category-title {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .toolbox-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
        }

        .toolbox-tag-button {
            padding: 4px 8px;
            background: var(--bg-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            color: var(--text-color);
        }

        .toolbox-tag-button:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .toolbox-tag-button:active {
            transform: translateY(0);
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ZZZ Guide YAML Generator</h1>
            <p class="subtitle">Create SZGF-compliant character guides without writing YAML by hand</p>
        </header>

        <div class="top-actions">
            <div class="action-buttons">
                <button onclick="App.clearForm()" class="button-danger">Clear Form</button>
            </div>
        </div>

        <div class="main-content">
            <div class="form-container">
                <form id="guideForm">
                    <!-- Required Section: Basic Information -->
                    <div class="section">
                        <div class="section-header">
                            <h2>
                                Basic Information
                                <span class="required-badge">Required</span>
                            </h2>
                            <span class="section-toggle">▼</span>
                        </div>
                        <div class="section-content">
                            <div class="form-group">
                                <label for="author">
                                    <div class="label-with-help">
                                        Author
                                        <span class="help-icon" data-help="Your name or username">?</span>
                                    </div>
                                </label>
                                <input type="text" id="author" required>
                            </div>

                            <div class="form-group">
                                <label for="lastUpdated">
                                    <div class="label-with-help">
                                        Last Updated
                                        <span class="help-icon" data-help="Date in YYYY-MM-DD format">?</span>
                                    </div>
                                </label>
                                <input type="date" id="lastUpdated" required>
                            </div>

                            <div class="form-group">
                                <label for="characterName">Character Name</label>
                                <input type="text" id="characterName" placeholder="e.g., Ellen Joe" required>
                            </div>

                            <div class="form-group">
                                <label for="characterRarity">Character Rarity</label>
                                <select id="characterRarity" required>
                                    <option value="">Select rarity...</option>
                                    <option value="4">4 (A-Rank)</option>
                                    <option value="5">5 (S-Rank)</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="characterBanner">
                                    <div class="label-with-help">
                                        Character Banner URL (optional)
                                        <span class="help-icon" data-help="Optional banner image URL">?</span>
                                    </div>
                                </label>
                                <input type="url" id="characterBanner" placeholder="https://...">
                            </div>

                            <div class="form-group">
                                <label for="description">Guide Description</label>
                                <textarea id="description" placeholder="Describe what this guide covers..." required
                                    onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Weapons Section -->
                    <div class="section">
                        <div class="section-header" onclick="UIHelper.toggleSection(this)">
                            <h2>
                                Weapons (W-Engines)
                                <span class="optional-badge">Optional</span>
                            </h2>
                            <span class="section-toggle collapsed">▼</span>
                        </div>
                        <div class="section-content collapsed">
                            <div id="weaponsContainer"></div>
                            <button type="button" class="add-button" onclick="UIHelper.addWeapon()">+ Add
                                Weapon</button>
                        </div>
                    </div>

                    <!-- Discs Section -->
                    <div class="section">
                        <div class="section-header" onclick="UIHelper.toggleSection(this)">
                            <h2>
                                Drive Discs
                                <span class="optional-badge">Optional</span>
                            </h2>
                            <span class="section-toggle collapsed">▼</span>
                        </div>
                        <div class="section-content collapsed">
                            <h3 style="margin-bottom: 15px;">4-Piece Sets</h3>
                            <div id="fourPieceContainer"></div>
                            <button type="button" class="add-button" onclick="UIHelper.addFourPiece()">+ Add 4-Piece
                                Set</button>

                            <h3 style="margin: 25px 0 15px 0;">2-Piece Sets</h3>
                            <div id="twoPieceContainer"></div>
                            <button type="button" class="add-button" onclick="UIHelper.addTwoPiece()">+ Add 2-Piece
                                Set</button>

                            <h3 style="margin: 25px 0 15px 0;">Extra Notes</h3>
                            <div id="discExtraContainer"></div>
                            <button type="button" class="add-button" onclick="UIHelper.addDiscExtra()">+ Add
                                Note</button>
                        </div>
                    </div>

                    <!-- Stats Section -->
                    <div class="section">
                        <div class="section-header" onclick="UIHelper.toggleSection(this)">
                            <h2>
                                Stats
                                <span class="optional-badge">Optional</span>
                            </h2>
                            <span class="section-toggle collapsed">▼</span>
                        </div>
                        <div class="section-content collapsed">
                            <h3 style="margin-bottom: 15px;">Main Stats by Disc Position</h3>

                            <div class="form-group">
                                <label for="mainStat4">Position 4 Priority</label>
                                <input type="text" id="mainStat4" placeholder="e.g., CRIT RATE% > CRIT DMG%">
                            </div>

                            <div class="form-group">
                                <label for="mainStat5">Position 5 Priority</label>
                                <input type="text" id="mainStat5" placeholder="e.g., Attribute DMG% > PEN%">
                            </div>

                            <div class="form-group">
                                <label for="mainStat6">Position 6 Priority</label>
                                <input type="text" id="mainStat6" placeholder="e.g., ATK% > Anomaly Mastery">
                            </div>

                            <div class="form-group">
                                <label for="subStats">
                                    <div class="label-with-help">
                                        Sub Stats Priority
                                        <span class="help-icon"
                                            data-help="Priority order for sub stats, e.g., 'CRIT RATE% > CRIT DMG% > ATK%'">?</span>
                                    </div>
                                </label>
                                <input type="text" id="subStats" placeholder="e.g., CRIT RATE% > CRIT DMG% > ATK%">
                            </div>

                            <div class="form-group">
                                <label for="baselineStats">
                                    <div class="label-with-help">
                                        Baseline Stats
                                        <span class="help-icon"
                                            data-help="Target stats to aim for, e.g., 'HP: 18000, ATK: 2500, CRIT RATE: 68%'">?</span>
                                    </div>
                                </label>
                                <textarea id="baselineStats" rows="3"
                                    placeholder="e.g., HP: 18000, ATK: 2500, CRIT RATE: 68%"
                                    onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                            </div>

                            <h3 style="margin: 25px 0 15px 0;">Extra Notes</h3>
                            <div id="statExtraContainer"></div>
                            <button type="button" class="add-button" onclick="UIHelper.addStatExtra()">+ Add
                                Note</button>
                        </div>
                    </div>

                    <!-- Skill Priority Section -->
                    <div class="section">
                        <div class="section-header" onclick="UIHelper.toggleSection(this)">
                            <h2>
                                Skill Priority
                                <span class="optional-badge">Optional</span>
                            </h2>
                            <span class="section-toggle collapsed">▼</span>
                        </div>
                        <div class="section-content collapsed">
                            <div id="priorityTiersContainer"></div>
                            <button type="button" class="add-button" onclick="UIHelper.addPriorityTier()">+ Add Priority
                                Tier</button>

                            <div class="form-group" style="margin-top: 20px;">
                                <label for="skillPriorityDesc">Priority Explanation</label>
                                <textarea id="skillPriorityDesc"
                                    placeholder="Explain why these skills should be prioritized..."
                                    onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Skills Section -->
                    <div class="section">
                        <div class="section-header" onclick="UIHelper.toggleSection(this)">
                            <h2>
                                Skills
                                <span class="optional-badge">Optional</span>
                            </h2>
                            <span class="section-toggle collapsed">▼</span>
                        </div>
                        <div class="section-content collapsed">
                            <div id="skillsContainer"></div>
                            <button type="button" class="add-button" onclick="UIHelper.addSkill()">+ Add Skill</button>
                        </div>
                    </div>

                    <!-- Mindscapes Section -->
                    <div class="section">
                        <div class="section-header" onclick="UIHelper.toggleSection(this)">
                            <h2>
                                Mindscape Cinema
                                <span class="optional-badge">Optional</span>
                            </h2>
                            <span class="section-toggle collapsed">▼</span>
                        </div>
                        <div class="section-content collapsed">
                            <div id="mindscapesContainer"></div>
                            <button type="button" class="add-button" onclick="UIHelper.addMindscape()">+ Add
                                Mindscape</button>
                        </div>
                    </div>

                    <!-- Teams Section -->
                    <div class="section">
                        <div class="section-header" onclick="UIHelper.toggleSection(this)">
                            <h2>
                                Teams
                                <span class="optional-badge">Optional</span>
                            </h2>
                            <span class="section-toggle collapsed">▼</span>
                        </div>
                        <div class="section-content collapsed">
                            <div id="teamsContainer"></div>
                            <button type="button" class="add-button" onclick="UIHelper.addTeam()">+ Add Team</button>

                            <h3 style="margin: 25px 0 15px 0;">Extra Team Notes</h3>
                            <div id="teamExtraContainer"></div>
                            <button type="button" class="add-button" onclick="UIHelper.addTeamExtra()">+ Add
                                Note</button>
                        </div>
                    </div>

                    <!-- Rotation Section -->
                    <div class="section">
                        <div class="section-header" onclick="UIHelper.toggleSection(this)">
                            <h2>
                                Rotation
                                <span class="optional-badge">Optional</span>
                            </h2>
                            <span class="section-toggle collapsed">▼</span>
                        </div>
                        <div class="section-content collapsed">
                            <div class="form-group">
                                <label for="rotationTitle">Rotation Title</label>
                                <input type="text" id="rotationTitle" placeholder="e.g., Standard DPS Rotation">
                            </div>

                            <div class="form-group">
                                <label for="rotationDesc">Rotation Description</label>
                                <textarea id="rotationDesc" placeholder="Describe the skill rotation..."
                                    onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="preview-container">
                <div class="preview-header">
                    <h2>YAML Preview</h2>
                </div>
                <div id="validationMessage"></div>
                <div id="yamlPreview"># Fill out the form to see YAML preview here...</div>
                <div class="action-buttons">
                    <button onclick="App.generateYAML()" class="button-success">Generate YAML</button>
                    <button onclick="App.downloadYAML()">Download .yml File</button>
                    <button onclick="App.copyToClipboard()" class="button-secondary">Copy to Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Toolbox -->
    <div id="floatingToolbox" class="floating-toolbox" onmousedown="event.preventDefault()"
        onmouseenter="Toolbox.cancelHide()">
        <div class="floating-toolbox-header">
            <h3>Quick Tags</h3>
            <button class="floating-toolbox-close"
                onclick="Toolbox.activeTextarea = null; Toolbox.cancelHide(); document.getElementById('floatingToolbox').classList.remove('visible');"
                title="Close">&times;</button>
        </div>
        <div class="floating-toolbox-content">
            <div class="toolbox-category">
                <div class="toolbox-category-title">Formatting</div>
                <div class="toolbox-buttons">
                    <button class="toolbox-tag-button" onclick="Toolbox.insertTag('**bold**')">Bold</button>
                    <button class="toolbox-tag-button" onclick="Toolbox.insertTag('*italic*')">Italic</button>
                </div>
            </div>
            <div class="toolbox-category">
                <div class="toolbox-category-title">Skill Tags</div>
                <div class="toolbox-buttons">
                    <button class="toolbox-tag-button" onclick="Toolbox.insertTag('<core>')">Core</button>
                    <button class="toolbox-tag-button" onclick="Toolbox.insertTag('<basic>')">Basic</button>
                    <button class="toolbox-tag-button" onclick="Toolbox.insertTag('<dodge>')">Dodge</button>
                    <button class="toolbox-tag-button" onclick="Toolbox.insertTag('<special>')">Special</button>
                    <button class="toolbox-tag-button" onclick="Toolbox.insertTag('<chain>')">Chain</button>
                    <button class="toolbox-tag-button" onclick="Toolbox.insertTag('<assist>')">Assist</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Floating Toolbox Manager
        const Toolbox = {
            activeTextarea: null,
            hideTimeout: null,

            show(textarea) {
                // Clear any pending hide
                if (this.hideTimeout) {
                    clearTimeout(this.hideTimeout);
                    this.hideTimeout = null;
                }

                this.activeTextarea = textarea;
                const toolbox = document.getElementById('floatingToolbox');
                toolbox.classList.add('visible');
            },

            hide() {
                this.hideTimeout = setTimeout(() => {
                    this.activeTextarea = null;
                    const toolbox = document.getElementById('floatingToolbox');
                    toolbox.classList.remove('visible');
                    this.hideTimeout = null;
                }, 150);
            },

            cancelHide() {
                if (this.hideTimeout) {
                    clearTimeout(this.hideTimeout);
                    this.hideTimeout = null;
                }
            },

            insertTag(tag) {
                if (!this.activeTextarea) return;

                const textarea = this.activeTextarea;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;

                textarea.value = text.substring(0, start) + tag + text.substring(end);

                // Position cursor after the inserted tag
                const newPos = start + tag.length;
                textarea.setSelectionRange(newPos, newPos);

                // Keep textarea focused and toolbox visible
                textarea.focus();
            }
        };

        // UI Helper
        const UIHelper = {
            weaponCounter: 0,
            fourPieceCounter: 0,
            twoPieceCounter: 0,
            discExtraCounter: 0,
            statExtraCounter: 0,
            skillCounter: 0,
            mindscapeCounter: 0,
            teamCounter: 0,
            teamExtraCounter: 0,
            priorityTierCounter: 0,
            skillTypes: ['core', 'basic', 'dodge', 'special', 'chain', 'assist'],
            maxPriorityTiers: 6,

            toggleSection(headerElement) {
                const toggle = headerElement.querySelector('.section-toggle');
                const content = headerElement.nextElementSibling;

                toggle.classList.toggle('collapsed');
                content.classList.toggle('collapsed');
            },

            addWeapon() {
                const container = document.getElementById('weaponsContainer');
                const id = this.weaponCounter++;
                const html = `
                    <div class="repeatable-item" data-id="${id}">
                        <button type="button" class="button-small button-danger remove-button" onclick="this.parentElement.remove()">Remove</button>
                        <div class="form-group">
                            <label>Weapon Name</label>
                            <input type="text" class="weapon-name" placeholder="e.g., Deep Sea Visitor">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="weapon-desc" placeholder="Why is this weapon good?" onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Custom Title (optional)</label>
                            <input type="text" class="weapon-title" placeholder="e.g., Best W-Engine">
                        </div>
                        <div class="form-group">
                            <label>Icon URL (optional)</label>
                            <input type="url" class="weapon-icon" placeholder="https://...">
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            },

            addFourPiece() {
                const container = document.getElementById('fourPieceContainer');
                const id = this.fourPieceCounter++;
                const html = `
                    <div class="repeatable-item" data-id="${id}">
                        <button type="button" class="button-small button-danger remove-button" onclick="this.parentElement.remove()">Remove</button>
                        <div class="form-group">
                            <label>Disc Set Name</label>
                            <input type="text" class="fourpiece-name" placeholder="e.g., Woodpecker Electro">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="fourpiece-desc" placeholder="Why use this disc set?" onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Icon URL (optional)</label>
                            <input type="url" class="fourpiece-icon" placeholder="https://...">
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            },

            addTwoPiece() {
                const container = document.getElementById('twoPieceContainer');
                const id = this.twoPieceCounter++;
                const html = `
                    <div class="repeatable-item" data-id="${id}">
                        <button type="button" class="button-small button-danger remove-button" onclick="this.parentElement.remove()">Remove</button>
                        <div class="form-group">
                            <label>Disc Set Name</label>
                            <input type="text" class="twopiece-name" placeholder="e.g., Puffer Electro">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="twopiece-desc" placeholder="Why use this disc set?" onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Icon URL (optional)</label>
                            <input type="url" class="twopiece-icon" placeholder="https://...">
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            },

            addDiscExtra() {
                const container = document.getElementById('discExtraContainer');
                const id = this.discExtraCounter++;
                const html = `
                    <div class="repeatable-item" data-id="${id}">
                        <button type="button" class="button-small button-danger remove-button" onclick="this.parentElement.remove()">Remove</button>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" class="discextra-title" placeholder="e.g., Additional Notes">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="discextra-desc" placeholder="Additional information..." onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            },

            addStatExtra() {
                const container = document.getElementById('statExtraContainer');
                const id = this.statExtraCounter++;
                const html = `
                    <div class="repeatable-item" data-id="${id}">
                        <button type="button" class="button-small button-danger remove-button" onclick="this.parentElement.remove()">Remove</button>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" class="statextra-title" placeholder="e.g., Important Notes">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="statextra-desc" placeholder="Additional information..." onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            },

            addSkill() {
                const container = document.getElementById('skillsContainer');
                const id = this.skillCounter++;
                const html = `
                    <div class="repeatable-item" data-id="${id}">
                        <button type="button" class="button-small button-danger remove-button" onclick="this.parentElement.remove()">Remove</button>
                        <div class="form-group">
                            <label>Skill Title</label>
                            <input type="text" class="skill-title" placeholder="e.g., Core Passive: Roaming Shark">
                        </div>
                        <div class="form-group">
                            <label>Skill Description</label>
                            <textarea class="skill-desc" placeholder="What does this skill do?" onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Skill Explanation</label>
                            <textarea class="skill-explanation" placeholder="How to use this skill effectively?" onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Demo GIF URL (optional)</label>
                            <input type="url" class="skill-demo" placeholder="https://...">
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            },

            addMindscape() {
                const container = document.getElementById('mindscapesContainer');

                // Check which mindscape numbers are already used
                const usedNumbers = new Set();
                container.querySelectorAll('.mindscape-number').forEach(input => {
                    const num = parseInt(input.value);
                    if (!isNaN(num)) {
                        usedNumbers.add(num);
                    }
                });

                // Check if all 6 mindscapes are already added
                if (usedNumbers.size >= 6) {
                    alert('Maximum 6 mindscapes allowed (M1 through M6).');
                    return;
                }

                const id = this.mindscapeCounter++;
                const html = `
                    <div class="repeatable-item" data-id="${id}">
                        <button type="button" class="button-small button-danger remove-button" onclick="UIHelper.removeMindscape(this)">Remove</button>
                        <div class="form-group">
                            <label>Mindscape Number</label>
                            <select class="mindscape-number" required onchange="UIHelper.updateMindscapeOptions()">
                                <option value="">Select M1-M6...</option>
                                <option value="1">M1</option>
                                <option value="2">M2</option>
                                <option value="3">M3</option>
                                <option value="4">M4</option>
                                <option value="5">M5</option>
                                <option value="6">M6</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Explanation</label>
                            <textarea class="mindscape-desc" rows="3" placeholder="Effects and importance..." onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
                this.updateMindscapeOptions();
            },

            removeMindscape(button) {
                button.closest('.repeatable-item').remove();
                this.updateMindscapeOptions();
            },

            updateMindscapeOptions() {
                const container = document.getElementById('mindscapesContainer');

                // Get all selected mindscape numbers
                const selectedNumbers = new Set();
                container.querySelectorAll('.mindscape-number').forEach(select => {
                    const num = parseInt(select.value);
                    if (!isNaN(num)) {
                        selectedNumbers.add(num);
                    }
                });

                // Update each select to disable already-selected options
                container.querySelectorAll('.mindscape-number').forEach(select => {
                    const currentValue = select.value;

                    // Enable all options first
                    Array.from(select.options).forEach(option => {
                        if (option.value !== '') {
                            const num = parseInt(option.value);
                            // Disable if selected elsewhere (but not in this select)
                            if (selectedNumbers.has(num) && option.value !== currentValue) {
                                option.disabled = true;
                            } else {
                                option.disabled = false;
                            }
                        }
                    });
                });
            },

            addTeam() {
                const container = document.getElementById('teamsContainer');
                const id = this.teamCounter++;
                const html = `
                    <div class="repeatable-item" data-id="${id}">
                        <button type="button" class="button-small button-danger remove-button" onclick="this.parentElement.remove()">Remove</button>
                        <div class="form-group">
                            <label>Team Name</label>
                            <input type="text" class="team-name" placeholder="e.g., Freeze Team">
                        </div>
                        <div class="form-group">
                            <label>Team Members</label>
                            <div class="team-member-list">
                                <div class="team-member-item">
                                    <input type="text" class="team-member" placeholder="Character 1">
                                    <button type="button" class="button-small button-success" onclick="UIHelper.addTeamMember(this)">+</button>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Team Description (optional)</label>
                            <textarea class="team-desc" placeholder="Why use this team?" onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            },

            addTeamMember(button) {
                const memberList = button.closest('.team-member-list');
                const html = `
                    <div class="team-member-item">
                        <input type="text" class="team-member" placeholder="Character">
                        <button type="button" class="button-small button-danger" onclick="this.parentElement.remove()">-</button>
                    </div>
                `;
                memberList.insertAdjacentHTML('beforeend', html);
            },

            addTeamExtra() {
                const container = document.getElementById('teamExtraContainer');
                const id = this.teamExtraCounter++;
                const html = `
                    <div class="repeatable-item" data-id="${id}">
                        <button type="button" class="button-small button-danger remove-button" onclick="this.parentElement.remove()">Remove</button>
                        <div class="form-group">
                            <label>Title</label>
                            <input type="text" class="teamextra-title" placeholder="e.g., Team Building Tips">
                        </div>
                        <div class="form-group">
                            <label>Description</label>
                            <textarea class="teamextra-desc" placeholder="Additional information..." onfocus="Toolbox.show(this)" onblur="Toolbox.hide()"></textarea>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            },

            addPriorityTier() {
                const container = document.getElementById('priorityTiersContainer');
                const currentTiers = container.querySelectorAll('.priority-tier').length;

                if (currentTiers >= this.maxPriorityTiers) {
                    alert(`Maximum ${this.maxPriorityTiers} priority tiers allowed (one for each skill type).`);
                    return;
                }

                const id = this.priorityTierCounter++;
                const tierNum = currentTiers + 1;
                const tierLabel = tierNum === 1 ? 'Highest' : tierNum === currentTiers + 1 ? 'Lowest' : `Tier ${tierNum}`;

                let checkboxesHtml = '';
                this.skillTypes.forEach(skill => {
                    const skillCapitalized = skill.charAt(0).toUpperCase() + skill.slice(1);
                    checkboxesHtml += `
                        <div class="checkbox-group">
                            <input type="checkbox" id="priority${id}_${skill}" value="${skill}" data-tier-id="${id}" onchange="UIHelper.handleSkillCheckboxChange(this)">
                            <label for="priority${id}_${skill}">${skillCapitalized}</label>
                        </div>
                    `;
                });

                const html = `
                    <div class="priority-tier repeatable-item" data-id="${id}">
                        <button type="button" class="button-small button-danger remove-button" onclick="UIHelper.removePriorityTier(this)">Remove</button>
                        <h4>Priority ${tierLabel}</h4>
                        <div class="skill-priority-grid">
                            ${checkboxesHtml}
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
                this.updatePriorityTierLabels();
            },

            removePriorityTier(button) {
                const tier = button.closest('.priority-tier');
                tier.remove();
                this.updatePriorityTierLabels();
                // Re-enable all checkboxes after removal
                this.updateCheckboxStates();
            },

            updatePriorityTierLabels() {
                const tiers = document.querySelectorAll('#priorityTiersContainer .priority-tier');
                tiers.forEach((tier, index) => {
                    const h4 = tier.querySelector('h4');
                    const totalTiers = tiers.length;
                    let label;

                    if (totalTiers === 1) {
                        label = 'Priority';
                    } else if (index === 0) {
                        label = 'Priority (Highest)';
                    } else if (index === totalTiers - 1) {
                        label = 'Priority (Lowest)';
                    } else {
                        label = `Priority Tier ${index + 1}`;
                    }

                    h4.textContent = label;
                });
            },

            handleSkillCheckboxChange(checkbox) {
                const skill = checkbox.value;
                const tierId = checkbox.dataset.tierId;

                if (checkbox.checked) {
                    // Uncheck this skill in all other tiers
                    document.querySelectorAll(`input[value="${skill}"]`).forEach(cb => {
                        if (cb.dataset.tierId !== tierId) {
                            cb.checked = false;
                        }
                    });
                }

                this.updateCheckboxStates();
            },

            updateCheckboxStates() {
                // Get all checked skills
                const checkedSkills = new Set();
                document.querySelectorAll('#priorityTiersContainer input[type="checkbox"]:checked').forEach(cb => {
                    checkedSkills.add(cb.value);
                });

                // Disable checkboxes for skills already selected in other tiers
                document.querySelectorAll('#priorityTiersContainer input[type="checkbox"]').forEach(cb => {
                    if (!cb.checked && checkedSkills.has(cb.value)) {
                        cb.disabled = true;
                        cb.parentElement.style.opacity = '0.5';
                    } else {
                        cb.disabled = false;
                        cb.parentElement.style.opacity = '1';
                    }
                });
            }
        };

        // Form Manager
        const FormManager = {
            collectFormData() {
                const data = {
                    author: document.getElementById('author').value,
                    last_updated: document.getElementById('lastUpdated').value,
                    character: {
                        name: document.getElementById('characterName').value,
                        rarity: parseInt(document.getElementById('characterRarity').value) || null
                    },
                    description: document.getElementById('description').value
                };

                // Character banner
                const banner = document.getElementById('characterBanner').value.trim();
                if (banner) {
                    data.character.banner = banner;
                }

                // Weapons
                const weapons = [];
                document.querySelectorAll('#weaponsContainer .repeatable-item').forEach(item => {
                    const name = item.querySelector('.weapon-name').value.trim();
                    const desc = item.querySelector('.weapon-desc').value.trim();
                    if (name && desc) {
                        const weapon = { name, description: desc };
                        const title = item.querySelector('.weapon-title').value.trim();
                        const icon = item.querySelector('.weapon-icon').value.trim();
                        if (title) weapon.title = title;
                        if (icon) weapon.icon = icon;
                        weapons.push(weapon);
                    }
                });
                if (weapons.length > 0) data.weapons = weapons;

                // Discs
                const fourPieces = [];
                document.querySelectorAll('#fourPieceContainer .repeatable-item').forEach(item => {
                    const name = item.querySelector('.fourpiece-name').value.trim();
                    const desc = item.querySelector('.fourpiece-desc').value.trim();
                    if (name && desc) {
                        const disc = { name, description: desc };
                        const icon = item.querySelector('.fourpiece-icon').value.trim();
                        if (icon) disc.icon = icon;
                        fourPieces.push(disc);
                    }
                });

                const twoPieces = [];
                document.querySelectorAll('#twoPieceContainer .repeatable-item').forEach(item => {
                    const name = item.querySelector('.twopiece-name').value.trim();
                    const desc = item.querySelector('.twopiece-desc').value.trim();
                    if (name && desc) {
                        const disc = { name, description: desc };
                        const icon = item.querySelector('.twopiece-icon').value.trim();
                        if (icon) disc.icon = icon;
                        twoPieces.push(disc);
                    }
                });

                const discExtra = [];
                document.querySelectorAll('#discExtraContainer .repeatable-item').forEach(item => {
                    const title = item.querySelector('.discextra-title').value.trim();
                    const desc = item.querySelector('.discextra-desc').value.trim();
                    if (title && desc) {
                        discExtra.push({ title, description: desc });
                    }
                });

                if (fourPieces.length > 0 || twoPieces.length > 0) {
                    data.discs = {
                        four_pieces: fourPieces,
                        two_pieces: twoPieces
                    };
                    if (discExtra.length > 0) {
                        data.discs.extra_sections = discExtra;
                    }
                }

                // Stats
                const mainStat4 = document.getElementById('mainStat4').value.trim();
                const mainStat5 = document.getElementById('mainStat5').value.trim();
                const mainStat6 = document.getElementById('mainStat6').value.trim();
                const subStats = document.getElementById('subStats').value.trim();
                const baselineStats = document.getElementById('baselineStats').value.trim();

                if (mainStat4 || mainStat5 || mainStat6 || subStats || baselineStats) {
                    const mainStats = [];
                    if (mainStat4) mainStats.push({ stat_priority: mainStat4, pos: 4 });
                    if (mainStat5) mainStats.push({ stat_priority: mainStat5, pos: 5 });
                    if (mainStat6) mainStats.push({ stat_priority: mainStat6, pos: 6 });

                    if (mainStats.length > 0 && subStats && baselineStats) {
                        data.stat = {
                            main_stats: mainStats,
                            sub_stats: subStats,
                            baseline_stats: baselineStats
                        };

                        const statExtra = [];
                        document.querySelectorAll('#statExtraContainer .repeatable-item').forEach(item => {
                            const title = item.querySelector('.statextra-title').value.trim();
                            const desc = item.querySelector('.statextra-desc').value.trim();
                            if (title && desc) {
                                statExtra.push({ title, description: desc });
                            }
                        });
                        if (statExtra.length > 0) {
                            data.stat.extra_sections = statExtra;
                        }
                    }
                }

                // Skill Priority
                const priorities = [];
                const priorityTiers = document.querySelectorAll('#priorityTiersContainer .priority-tier');
                priorityTiers.forEach(tier => {
                    const skills = [];
                    tier.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                        skills.push(checkbox.value);
                    });
                    if (skills.length > 0) {
                        priorities.push(skills);
                    }
                });

                const skillPriorityDesc = document.getElementById('skillPriorityDesc').value.trim();
                if (priorities.length > 0 && skillPriorityDesc) {
                    data.skill_priority = {
                        priorities,
                        description: skillPriorityDesc
                    };
                }

                // Skills
                const skills = [];
                document.querySelectorAll('#skillsContainer .repeatable-item').forEach(item => {
                    const title = item.querySelector('.skill-title').value.trim();
                    const desc = item.querySelector('.skill-desc').value.trim();
                    const explanation = item.querySelector('.skill-explanation').value.trim();
                    if (title && desc && explanation) {
                        const skill = { title, description: desc, explanation };
                        const demo = item.querySelector('.skill-demo').value.trim();
                        if (demo) skill.demo = demo;
                        skills.push(skill);
                    }
                });
                if (skills.length > 0) data.skills = skills;

                // Mindscapes
                const mindscapes = [];
                document.querySelectorAll('#mindscapesContainer .repeatable-item').forEach(item => {
                    const num = parseInt(item.querySelector('.mindscape-number').value);
                    const desc = item.querySelector('.mindscape-desc').value.trim();
                    if (!isNaN(num) && num >= 1 && num <= 6 && desc) {
                        mindscapes.push({ num: num, description: desc });
                    }
                });
                // Sort mindscapes by number
                mindscapes.sort((a, b) => a.num - b.num);
                if (mindscapes.length > 0) data.mindscapes = mindscapes;

                // Teams
                const teams = [];
                document.querySelectorAll('#teamsContainer .repeatable-item').forEach(item => {
                    const name = item.querySelector('.team-name').value.trim();
                    const members = [];
                    item.querySelectorAll('.team-member').forEach(input => {
                        const memberName = input.value.trim();
                        if (memberName) members.push({ name: memberName });
                    });
                    if (name && members.length > 0) {
                        const team = { name, characters: members };
                        const desc = item.querySelector('.team-desc').value.trim();
                        if (desc) team.description = desc;
                        teams.push(team);
                    }
                });

                const teamExtra = [];
                document.querySelectorAll('#teamExtraContainer .repeatable-item').forEach(item => {
                    const title = item.querySelector('.teamextra-title').value.trim();
                    const desc = item.querySelector('.teamextra-desc').value.trim();
                    if (title && desc) {
                        teamExtra.push({ title, description: desc });
                    }
                });

                if (teams.length > 0 || teamExtra.length > 0) {
                    data.team = {};
                    if (teams.length > 0) data.team.teams = teams;
                    if (teamExtra.length > 0) data.team.extra_sections = teamExtra;
                }

                // Rotation
                const rotationTitle = document.getElementById('rotationTitle').value.trim();
                const rotationDesc = document.getElementById('rotationDesc').value.trim();
                if (rotationTitle && rotationDesc) {
                    data.rotation = {
                        title: rotationTitle,
                        description: rotationDesc
                    };
                }

                return data;
            }
        };

        // YAML Generator
        const YAMLGenerator = {
            generateYAML(data) {
                let yaml = '';

                // Required fields
                yaml += `author: ${this.escapeString(data.author)}\n`;
                yaml += `last_updated: "${data.last_updated}"\n`;
                yaml += `character:\n`;
                yaml += `  name: ${this.escapeString(data.character.name)}\n`;
                yaml += `  rarity: ${data.character.rarity}\n`;
                if (data.character.banner) {
                    yaml += `  banner: ${this.escapeString(data.character.banner)}\n`;
                }
                yaml += `description: ${this.formatMultiline(data.description, 0)}\n`;

                // Weapons
                if (data.weapons && data.weapons.length > 0) {
                    yaml += `weapons:\n`;
                    data.weapons.forEach(weapon => {
                        yaml += `  - name: ${this.escapeString(weapon.name)}\n`;
                        yaml += `    description: ${this.formatMultiline(weapon.description, 4)}\n`;
                        if (weapon.title) {
                            yaml += `    title: ${this.escapeString(weapon.title)}\n`;
                        }
                        if (weapon.icon) {
                            yaml += `    icon: ${this.escapeString(weapon.icon)}\n`;
                        }
                    });
                }

                // Discs
                if (data.discs) {
                    yaml += `discs:\n`;
                    yaml += `  four_pieces:\n`;
                    if (data.discs.four_pieces.length === 0) {
                        yaml += `    []\n`;
                    } else {
                        data.discs.four_pieces.forEach(disc => {
                            yaml += `    - name: ${this.escapeString(disc.name)}\n`;
                            yaml += `      description: ${this.formatMultiline(disc.description, 6)}\n`;
                            if (disc.icon) {
                                yaml += `      icon: ${this.escapeString(disc.icon)}\n`;
                            }
                        });
                    }
                    yaml += `  two_pieces:\n`;
                    if (data.discs.two_pieces.length === 0) {
                        yaml += `    []\n`;
                    } else {
                        data.discs.two_pieces.forEach(disc => {
                            yaml += `    - name: ${this.escapeString(disc.name)}\n`;
                            yaml += `      description: ${this.formatMultiline(disc.description, 6)}\n`;
                            if (disc.icon) {
                                yaml += `      icon: ${this.escapeString(disc.icon)}\n`;
                            }
                        });
                    }
                    if (data.discs.extra_sections && data.discs.extra_sections.length > 0) {
                        yaml += `  extra_sections:\n`;
                        data.discs.extra_sections.forEach(section => {
                            yaml += `    - title: ${this.escapeString(section.title)}\n`;
                            yaml += `      description: ${this.formatMultiline(section.description, 6)}\n`;
                        });
                    }
                }

                // Stats
                if (data.stat) {
                    yaml += `stat:\n`;
                    yaml += `  main_stats:\n`;
                    data.stat.main_stats.forEach(stat => {
                        yaml += `    - stat_priority: ${this.escapeString(stat.stat_priority)}\n`;
                        yaml += `      pos: ${stat.pos}\n`;
                    });
                    yaml += `  sub_stats: ${this.escapeString(data.stat.sub_stats)}\n`;
                    yaml += `  baseline_stats: ${this.formatMultiline(data.stat.baseline_stats, 2)}\n`;
                    if (data.stat.extra_sections && data.stat.extra_sections.length > 0) {
                        yaml += `  extra_sections:\n`;
                        data.stat.extra_sections.forEach(section => {
                            yaml += `    - title: ${this.escapeString(section.title)}\n`;
                            yaml += `      description: ${this.formatMultiline(section.description, 6)}\n`;
                        });
                    }
                }

                // Skill Priority
                if (data.skill_priority) {
                    yaml += `skill_priority:\n`;
                    yaml += `  priorities:\n`;
                    data.skill_priority.priorities.forEach(tier => {
                        yaml += `    - [${tier.join(', ')}]\n`;
                    });
                    yaml += `  description: ${this.formatMultiline(data.skill_priority.description, 2)}\n`;
                }

                // Skills
                if (data.skills && data.skills.length > 0) {
                    yaml += `skills:\n`;
                    data.skills.forEach(skill => {
                        yaml += `  - title: ${this.escapeString(skill.title)}\n`;
                        yaml += `    description: ${this.formatMultiline(skill.description, 4)}\n`;
                        yaml += `    explanation: ${this.formatMultiline(skill.explanation, 4)}\n`;
                        if (skill.demo) {
                            yaml += `    demo: ${this.escapeString(skill.demo)}\n`;
                        }
                    });
                }

                // Mindscapes
                if (data.mindscapes && data.mindscapes.length > 0) {
                    yaml += `mindscapes:\n`;
                    data.mindscapes.forEach(mindscape => {
                        yaml += `  - num: ${mindscape.num}\n`;
                        yaml += `    description: ${this.formatMultiline(mindscape.description, 4)}\n`;
                    });
                }

                // Teams
                if (data.team) {
                    yaml += `team:\n`;
                    if (data.team.teams && data.team.teams.length > 0) {
                        yaml += `  teams:\n`;
                        data.team.teams.forEach(team => {
                            yaml += `    - name: ${this.escapeString(team.name)}\n`;
                            yaml += `      characters:\n`;
                            team.characters.forEach(member => {
                                yaml += `        - name: ${this.escapeString(member.name)}\n`;
                            });
                            if (team.description) {
                                yaml += `      description: ${this.formatMultiline(team.description, 6)}\n`;
                            }
                        });
                    }
                    if (data.team.extra_sections && data.team.extra_sections.length > 0) {
                        yaml += `  extra_sections:\n`;
                        data.team.extra_sections.forEach(section => {
                            yaml += `    - title: ${this.escapeString(section.title)}\n`;
                            yaml += `      description: ${this.formatMultiline(section.description, 6)}\n`;
                        });
                    }
                }

                // Rotation
                if (data.rotation) {
                    yaml += `rotation:\n`;
                    yaml += `  title: ${this.escapeString(data.rotation.title)}\n`;
                    yaml += `  description: ${this.formatMultiline(data.rotation.description, 2)}\n`;
                }

                return yaml;
            },

            escapeString(str) {
                if (!str) return '""';
                // If string contains special characters, quote it
                if (str.includes(':') || str.includes('#') || str.includes('"') || str.includes("'") || str.includes('[') || str.includes(']') || str.includes('{') || str.includes('}')) {
                    return '"' + str.replace(/"/g, '\\"') + '"';
                }
                return str;
            },

            formatMultiline(text, indent) {
                if (!text) return '""';
                if (!text.includes('\n') && text.length < 80) {
                    return this.escapeString(text);
                }

                // Use YAML block scalar >- for multi-line text
                const lines = text.split('\n');
                const indentStr = ' '.repeat(indent + 2);
                return '>-\n' + indentStr + lines.join('\n' + indentStr);
            }
        };

        // App
        const App = {
            init() {
                // Set today's date
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('lastUpdated').value = today;

                // Set up event listeners for required fields
                const requiredFields = ['author', 'lastUpdated', 'characterName', 'characterRarity', 'description'];
                requiredFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.addEventListener('input', () => this.updateButtonStates());
                        field.addEventListener('change', () => this.updateButtonStates());
                    }
                });

                // Initial button state check
                this.updateButtonStates();
            },

            checkRequiredFields() {
                const author = document.getElementById('author').value.trim();
                const lastUpdated = document.getElementById('lastUpdated').value.trim();
                const characterName = document.getElementById('characterName').value.trim();
                const characterRarity = document.getElementById('characterRarity').value;
                const description = document.getElementById('description').value.trim();

                return author && lastUpdated && characterName && characterRarity && description;
            },

            updateButtonStates() {
                const allRequiredFilled = this.checkRequiredFields();
                const generateButton = document.querySelector('button[onclick="App.generateYAML()"]');
                const downloadButton = document.querySelector('button[onclick="App.downloadYAML()"]');
                const copyButton = document.querySelector('button[onclick="App.copyToClipboard()"]');

                generateButton.disabled = !allRequiredFilled;
                downloadButton.disabled = !allRequiredFilled;
                copyButton.disabled = !allRequiredFilled;
            },

            generateYAML() {
                if (!this.checkRequiredFields()) {
                    return;
                }

                const data = FormManager.collectFormData();
                const yaml = YAMLGenerator.generateYAML(data);
                document.getElementById('yamlPreview').textContent = yaml;
            },



            downloadYAML() {
                if (!this.checkRequiredFields()) {
                    alert('Fill in all required fields before downloading.');
                    return;
                }

                const yamlContent = document.getElementById('yamlPreview').textContent;
                if (!yamlContent || yamlContent.startsWith('#')) {
                    alert('Generate YAML first!');
                    return;
                }

                const characterName = document.getElementById('characterName').value.trim();
                const filename = characterName
                    ? `${characterName.toLowerCase().replace(/\s+/g, '-')}.yml`
                    : 'character.yml';

                const blob = new Blob([yamlContent], { type: 'text/yaml' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                a.click();
                URL.revokeObjectURL(url);
            },

            async copyToClipboard() {
                if (!this.checkRequiredFields()) {
                    alert('Fill in all required fields before copying.');
                    return;
                }

                const yamlContent = document.getElementById('yamlPreview').textContent;
                if (!yamlContent || yamlContent.startsWith('#')) {
                    alert('Generate YAML first!');
                    return;
                }

                try {
                    await navigator.clipboard.writeText(yamlContent);
                    const button = event.target;
                    const originalText = button.textContent;
                    button.textContent = 'Copied!';
                    button.classList.add('button-success');
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('button-success');
                    }, 2000);
                } catch (e) {
                    alert('Failed to copy to clipboard, copy manually.');
                }
            },

            clearForm() {
                if (!confirm('Are you sure you want to clear the entire form?')) {
                    return;
                }

                // Save the last updated date before resetting
                const lastUpdated = document.getElementById('lastUpdated').value;

                document.getElementById('guideForm').reset();
                document.getElementById('weaponsContainer').innerHTML = '';
                document.getElementById('fourPieceContainer').innerHTML = '';
                document.getElementById('twoPieceContainer').innerHTML = '';
                document.getElementById('discExtraContainer').innerHTML = '';
                document.getElementById('statExtraContainer').innerHTML = '';
                document.getElementById('priorityTiersContainer').innerHTML = '';
                document.getElementById('skillsContainer').innerHTML = '';
                document.getElementById('mindscapesContainer').innerHTML = '';
                document.getElementById('teamsContainer').innerHTML = '';
                document.getElementById('teamExtraContainer').innerHTML = '';

                // Reset checkboxes
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);

                // Restore the last updated date
                document.getElementById('lastUpdated').value = lastUpdated;

                // Clear validation message and reset button states
                document.getElementById('validationMessage').innerHTML = '';
                this.updateButtonStates();
            }
        };

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>

</html>